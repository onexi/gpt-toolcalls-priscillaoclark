<!DOCTYPE html>
<html data-bs-theme="dark">
  <head>
    <title>PS04 - Managing Assistants</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style src="styles.css"></style>

    <script>
      let state = {
        chatgpt:false,
        assistant_id: "",
        assistant_name: "",
        dir_path: "",
        news_path: "",
        thread_id: "",
        user_message: "",
        run_id: "",
        run_status: "",
        vector_store_id: "",
        tools:[],
        parameters: []
      };

      async function get_data_from_elements() {
        for (let key in state) {
          if (document.getElementById(key) != null) {
            state[key] = document.getElementById(key).value;
          }
        }
        console.log(`getting data from elements: ${JSON.stringify(state)}`);
      }

      function write_data_to_elements(response) {
        for (let key in response) {
          if (document.getElementById(key) != null) {
            document.getElementById(key).value = response[key];
          }
        }
        console.log(`writing data to elements: ${JSON.stringify(state)}`);
      }

      function write_to_div(route, message) {
        // Ensure response is a valid array;
        if (!Array.isArray(message)) {
          let responseDiv = document.getElementById("response");
          responseDiv.innerHTML = JSON.stringify(message);
          return;
        }

        // Select the target div
        let responseDiv = document.getElementById("response");
        if (!responseDiv) {
          console.error("No div with id 'response' found.");
          return;
        }

        // Clear previous contents
        responseDiv.innerHTML = "";

        // Iterate through each object in the array
        message.forEach((item) => {
          // Create a new span element for each item
          var span = document.createElement("span");
          span.style.color = "black"; // Default color
          // check if item.content or item.function
          let matches = [];
          if ("content" in item) {
            span.textContent = item.content;
            // check for ``` that indicates code block
            if (item.content.includes("```")) {
              const regex = /```([^```]+)```/g;

              // Find matches

              let match;
              while ((match = regex.exec(span.textContent)) !== null) {
                matches.push(match[1].trim());
              }

              // Insert extracted text into the div
              const outputDiv = document.getElementById("json_output");
              outputDiv.textContent = matches.join("\n\n");
            }
            // remove text between ``` from the content
            span.textContent = span.textContent.replace(matches, "");
            span.textContent = span.textContent.replace("\n", "");
          }
          // check if item.function exists

          if ("function" in item) {
            span.textContent = JSON.stringify(item.function);
          } else {
            span.textContent = JSON.stringify(item);
          }

          // Assign color based on the role
          switch (item.role) {
            case "user":
              span.style.color = "yellow";
              break;
            case "assistant":
              span.style.color = "white";
              break;
            case "system":
              span.style.color = "red";
              break;
            case "function":
              span.style.color = "turquoise";
              break;
            default:
              span.style.color = "magenta"; // Default color
          }

          // Append the span to the div
          responseDiv.appendChild(span);
          responseDiv.appendChild(document.createElement("br")); // Add a line break for readability
        });
      }
      async function sendRequest(action) {
        get_data_from_elements();
        
        // Get the selected target (Assistant or ChatGPT) from the dropdown
        const selectedTarget = document.getElementById("target_selection").value;
        
        let route;
        
        // Determine route based on the selection
        if (selectedTarget === "assistant") {
          route = `api/assistant/${action}`;
        } else if (selectedTarget === "chatgpt") {
          route = `api/chatgpt/${action}`;
        }
      
        console.log(`sending data: ${JSON.stringify(state)} to ${route}`);
        let response = await fetch(`/${route}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(state),
          mode: "cors",
        });
        let res = await response.json(); // we always get back {message, state}
        console.log(`In UI response: ${JSON.stringify(res)}`);
        await parse_response(route, res);
      
        return;
      }
      async function sendRequest(route) {
        get_data_from_elements();
            // Get the selected target (Assistant or ChatGPT) from the dropdown
      
        console.log(`sending data: ${JSON.stringify(state)} to ${route}`);
        let response = await fetch(`/${route}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(state),
          mode: "cors",
        });
        let res = await response.json(); // we always get back {message, state}
        console.log(`In UI response: ${JSON.stringify(res)}`);
        await parse_response(route, res);

        return;
      }
      async function parse_response(route, res) {
        console.log(
          `In UI parse_response ${route} data =: ${JSON.stringify(res.state)}`
        );
        write_data_to_elements(res.state);
        console.log(`Updated state:: ${JSON.stringify(state)}`);
        console.log(`write to div: ${JSON.stringify(res.message)}`);
        write_to_div(route, res.message);
      }
    </script>
  </head>
  <body>
    <div class="container mt-5">
      <div class="card shadow-lg">
        <div class="card-body">
          <!-- Header Section -->
          <section class="part2 mb-4">
            <div class="row justify-content-center">
              <div class="col-12 col-md-8">
                <h4 class="text-center text-md-left">MIT Agent Function Caller - PS04 Priscilla Clark</h4>
              </div>
            </div>
          </section>
  
          <!-- Input Section -->
          <div class="row mb-5">
            <div class="col-12">
              <p class="mb-2">Step 1: Input User Message</p>
              <input
                type="text"
                id="user_message"
                name="user_message"
                value="Ask a question about the current weather in a city..."
                class="form-control"
              />
            </div>
  
            <div class="col-12 mt-4">
              <p>Step 2: Set User Prompt</p>
              <button
                class="btn btn-primary btn-block"
                type="submit"
                onclick="sendRequest('api/prompt')"
              >
                Input User Prompt
              </button>
            </div>
  
            <div class="col-12 mt-4">
              <p>Step 3: Run Agent</p>
              <button
                class="btn btn-success btn-block"
                type="submit"
                onclick="sendRequest('api/openai-call')"
              >
                Run Agent
              </button>
            </div>
          </div>
  
          <!-- Response Section -->
          <div class="container mt-5">
            <label for="response" class="form-label">Agent Context Window:</label>
            <div
              id="response"
              class="border rounded p-3 bg-light"
              style="height: 200px; overflow-y: auto; color: black;"
            ></div>
          </div>
        </div>
      </div>
    </div>
  
    <style>
      /* Responsive text alignment */
      h4 {
        font-size: 1.5rem;
      }
  
      @media (max-width: 768px) {
        h4 {
          text-align: center;
        }
      }
  
      /* Input and button responsiveness */
      input[type="text"] {
        width: 100%;
      }
  
      /* Button styling */
      .btn {
        padding: 10px 20px;
        font-size: 1rem;
      }
  
      .btn-block {
        width: 100%;
      }
  
      /* Card styling */
      .card {
        border: none;
      }
  
      .card-body {
        padding: 30px;
      }
  
      /* Box shadow for card */
      .card.shadow-lg {
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
    </style>
  </body>
</html>